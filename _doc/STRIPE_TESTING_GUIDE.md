# Stripe æ”¯ä»˜æµ‹è¯•æŒ‡å—

## ðŸŽ¯ å®Œæ•´æµ‹è¯•æµç¨‹

### å‡†å¤‡å·¥ä½œ

1. **ç¡®ä¿æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨**ï¼š
   ```powershell
   # åŽç«¯ï¼ˆåœ¨ pipenv ç»ˆç«¯ï¼‰
   cd "D:\ZhuoMian\Social Commerce"
   pipenv run python backend/manage.py runserver
   
   # å‰ç«¯ï¼ˆåœ¨å¦ä¸€ä¸ªç»ˆç«¯ï¼‰
   cd frontend
   npm run dev
   
   # Stripe Webhook è½¬å‘ï¼ˆåœ¨ç¬¬ä¸‰ä¸ªç»ˆç«¯ï¼‰
   stripe listen --forward-to http://localhost:8000/api/shopping/payments/webhook/
   ```

2. **é…ç½® Webhook Secret**ï¼š
   - ä»Ž `stripe listen` çš„è¾“å‡ºä¸­å¤åˆ¶ `whsec_xxxxx`
   - åœ¨ `backend/.env` ä¸­è®¾ç½®ï¼š
     ```
     STRIPE_WEBHOOK_SECRET=whsec_ä½ å¤åˆ¶çš„å¯†é’¥
     ```

### æµ‹è¯•æ­¥éª¤

#### 1ï¸âƒ£ åˆ›å»ºè®¢å•å¹¶æ”¯ä»˜

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:5173
2. ç™»å½•ä½ çš„è´¦å·
3. è®¿é—®å•†å“é¡µé¢ï¼ˆ/merchï¼‰
4. é€‰æ‹©å•†å“ï¼Œç‚¹å‡»"åŠ å…¥è´­ç‰©è½¦"
5. ç‚¹å‡»"åŽ»ç»“ç®—"
6. é€‰æ‹©æ”¶è´§åœ°å€ï¼ˆæˆ–æ·»åŠ æ–°åœ°å€ï¼‰
7. ç‚¹å‡»"æäº¤è®¢å•å¹¶æ”¯ä»˜"
8. è‡ªåŠ¨è·³è½¬åˆ° Stripe Checkout é¡µé¢

#### 2ï¸âƒ£ åœ¨ Stripe é¡µé¢å®Œæˆæ”¯ä»˜

**æµ‹è¯•å¡å·ï¼ˆCNY - äººæ°‘å¸ï¼‰**ï¼š

| å¡å· | è¿‡æœŸæ—¥æœŸ | CVC | é‚®ç¼– | ç»“æžœ |
|------|---------|-----|------|------|
| `4242 4242 4242 4242` | `12/34` | `123` | `12345` | âœ… æ”¯ä»˜æˆåŠŸ |
| `4000 0025 0000 3155` | `12/34` | `123` | `12345` | ðŸ” éœ€è¦ 3D Secure éªŒè¯ |
| `4000 0000 0000 9995` | `12/34` | `123` | `12345` | âŒ ä½™é¢ä¸è¶³ |
| `4000 0000 0000 0002` | `12/34` | `123` | `12345` | âŒ å¡è¢«æ‹’ç» |
| `4000 0000 0000 0069` | `12/34` | `123` | `12345` | âŒ è¿‡æœŸå¡ç‰‡ |

**å¡«å†™æ­¥éª¤**ï¼š
1. **å¡å·**ï¼šè¾“å…¥æµ‹è¯•å¡å·ï¼ˆå¦‚ `4242 4242 4242 4242`ï¼‰
2. **è¿‡æœŸæ—¥æœŸ**ï¼šä»»ä½•æœªæ¥æ—¥æœŸï¼ˆå¦‚ `12/34`ï¼‰
3. **CVC**ï¼šä»»æ„3ä½æ•°å­—ï¼ˆå¦‚ `123`ï¼‰
4. **æŒå¡äººå§“å**ï¼šä»»æ„åå­—ï¼ˆå¦‚ `Test User`ï¼‰
5. **é‚®æ”¿ç¼–ç **ï¼šä»»æ„é‚®ç¼–ï¼ˆå¦‚ `12345` æˆ– `100000`ï¼‰
6. **å›½å®¶/åœ°åŒº**ï¼šé€‰æ‹© Chinaï¼ˆå¦‚æžœéœ€è¦ï¼‰
7. ç‚¹å‡»"æ”¯ä»˜"æŒ‰é’®

#### 3ï¸âƒ£ éªŒè¯æ”¯ä»˜ç»“æžœ

**å‰ç«¯**ï¼š
- æ”¯ä»˜æˆåŠŸåŽè·³è½¬åˆ° `/order-success` é¡µé¢
- ç‚¹å‡»"æŸ¥çœ‹æˆ‘çš„è®¢å•"
- åœ¨ `/myself?tab=orders` æŸ¥çœ‹è®¢å•çŠ¶æ€æ˜¯å¦ä¸º"å·²æ”¯ä»˜"

**åŽç«¯**ï¼š
- æŸ¥çœ‹ Django ç»ˆç«¯æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
  ```
  âœ… è®¢å• XX æ”¯ä»˜æˆåŠŸï¼Œå·²æ›´æ–°çŠ¶æ€
  ```

**Stripe CLI**ï¼š
- æŸ¥çœ‹ `stripe listen` ç»ˆç«¯ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
  ```
  --> checkout.session.completed [evt_xxxxx]
  <-- [200] POST http://localhost:8000/api/shopping/payments/webhook/
  ```

**Stripe Dashboard**ï¼š
- è®¿é—®ï¼šhttps://dashboard.stripe.com/test/payments
- æŸ¥çœ‹æœ€æ–°çš„æ”¯ä»˜è®°å½•
- ç¡®è®¤é‡‘é¢å’Œè´§å¸ï¼ˆCNYï¼‰æ­£ç¡®

#### 4ï¸âƒ£ æµ‹è¯•å¾…ä»˜æ¬¾è®¢å•é‡æ–°æ”¯ä»˜

1. åˆ›å»ºä¸€ä¸ªè®¢å•ä½†ä¸å®Œæˆæ”¯ä»˜ï¼ˆç‚¹å‡»"å–æ¶ˆ"æŒ‰é’®ï¼‰
2. è®¿é—® `/myself?tab=orders`
3. æ‰¾åˆ°"å¾…ä»˜æ¬¾"è®¢å•
4. ç‚¹å‡»"ç«‹å³æ”¯ä»˜"æŒ‰é’®
5. å®Œæˆ Stripe æ”¯ä»˜
6. è¿”å›žåŽæŸ¥çœ‹è®¢å•çŠ¶æ€æ˜¯å¦æ›´æ–°

## ðŸ’³ CNYï¼ˆäººæ°‘å¸ï¼‰æ”¯ä»˜è¯´æ˜Ž

### å·²é…ç½®
âœ… åŽç«¯è´§å¸å•ä½å·²è®¾ç½®ä¸º `'cny'`ï¼ˆäººæ°‘å¸ï¼‰

### è´§å¸æ˜¾ç¤º
- åœ¨ Stripe Checkout é¡µé¢ä¼šæ˜¾ç¤º **Â¥** ç¬¦å·
- é‡‘é¢ä»¥äººæ°‘å¸è®¡ç®—
- ä¾‹å¦‚ï¼šå•†å“ä»·æ ¼ Â¥100.00

### æ”¯æŒçš„æ”¯ä»˜æ–¹å¼
- âœ… å›½é™…ä¿¡ç”¨å¡ï¼ˆVisaã€Mastercardã€American Expressï¼‰
- âœ… æ”¯æŒ 3D Secure éªŒè¯
- âœ… æµ‹è¯•å¡å·åŒæ ·é€‚ç”¨

## ðŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šæˆåŠŸæ”¯ä»˜
```
å¡å·: 4242 4242 4242 4242
è¿‡æœŸ: 12/34
CVC: 123
ç»“æžœ: âœ… æ”¯ä»˜æˆåŠŸï¼Œè®¢å•çŠ¶æ€æ›´æ–°ä¸º"å·²æ”¯ä»˜"
```

### åœºæ™¯ 2ï¼šéœ€è¦éªŒè¯
```
å¡å·: 4000 0025 0000 3155
è¿‡æœŸ: 12/34
CVC: 123
ç»“æžœ: ðŸ” å¼¹å‡º 3D Secure éªŒè¯æ¡†ï¼Œå®ŒæˆéªŒè¯åŽæ”¯ä»˜æˆåŠŸ
```

### åœºæ™¯ 3ï¼šä½™é¢ä¸è¶³
```
å¡å·: 4000 0000 0000 9995
è¿‡æœŸ: 12/34
CVC: 123
ç»“æžœ: âŒ æ˜¾ç¤º"ä½™é¢ä¸è¶³"é”™è¯¯ï¼Œæ”¯ä»˜å¤±è´¥
```

### åœºæ™¯ 4ï¼šå¡è¢«æ‹’ç»
```
å¡å·: 4000 0000 0000 0002
è¿‡æœŸ: 12/34
CVC: 123
ç»“æžœ: âŒ æ˜¾ç¤º"å¡è¢«æ‹’ç»"é”™è¯¯ï¼Œæ”¯ä»˜å¤±è´¥
```

## ðŸ“Š éªŒè¯æ£€æŸ¥æ¸…å•

æµ‹è¯•å®ŒæˆåŽï¼Œæ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

- [ ] è®¢å•åˆ›å»ºæˆåŠŸ
- [ ] è·³è½¬åˆ° Stripe Checkout é¡µé¢
- [ ] Checkout é¡µé¢æ˜¾ç¤ºæ­£ç¡®çš„é‡‘é¢å’Œè´§å¸ï¼ˆÂ¥ï¼‰
- [ ] èƒ½å¤Ÿè¾“å…¥æµ‹è¯•å¡å·
- [ ] æ”¯ä»˜æˆåŠŸåŽè·³è½¬åˆ°æˆåŠŸé¡µé¢
- [ ] è®¢å•çŠ¶æ€æ›´æ–°ä¸º"å·²æ”¯ä»˜"
- [ ] Webhook æ”¶åˆ° `checkout.session.completed` äº‹ä»¶
- [ ] åŽç«¯æ—¥å¿—æ˜¾ç¤ºè®¢å•æ›´æ–°æˆåŠŸ
- [ ] Stripe Dashboard æ˜¾ç¤ºæ”¯ä»˜è®°å½•
- [ ] å¾…ä»˜æ¬¾è®¢å•å¯ä»¥é‡æ–°æ”¯ä»˜

## ðŸ” å¸¸è§é—®é¢˜æŽ’æŸ¥

### Q: Webhook æ²¡æœ‰æ”¶åˆ°äº‹ä»¶ï¼Ÿ
**æ£€æŸ¥**ï¼š
- `stripe listen` æ˜¯å¦æ­£åœ¨è¿è¡Œ
- `STRIPE_WEBHOOK_SECRET` æ˜¯å¦é…ç½®æ­£ç¡®
- åŽç«¯æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ

**è§£å†³**ï¼š
```powershell
# é‡å¯ stripe listen
stripe listen --forward-to http://localhost:8000/api/shopping/payments/webhook/
# å¤åˆ¶æ–°çš„ whsec_xxx å¹¶æ›´æ–°åˆ° .env
```

### Q: æ”¯ä»˜æˆåŠŸä½†è®¢å•çŠ¶æ€æœªæ›´æ–°ï¼Ÿ
**æ£€æŸ¥**ï¼š
- æŸ¥çœ‹ `stripe listen` ç»ˆç«¯ï¼Œæ˜¯å¦è¿”å›ž 200
- æŸ¥çœ‹ Django ç»ˆç«¯ï¼Œæ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—
- æ£€æŸ¥è®¢å• ID æ˜¯å¦æ­£ç¡®ä¼ é€’

**è§£å†³**ï¼š
```python
# åœ¨åŽç«¯ views.py çš„ stripe_webhook å‡½æ•°ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—
print(f'æ”¶åˆ°äº‹ä»¶: {event_type}')
print(f'è®¢å•ID: {order_id}')
```

### Q: è·³è½¬åˆ° Stripe é¡µé¢åŽæ˜¾ç¤ºé”™è¯¯ï¼Ÿ
**æ£€æŸ¥**ï¼š
- åŽç«¯è¿”å›žçš„ URL æ˜¯å¦æ­£ç¡®
- Stripe å¯†é’¥æ˜¯å¦æœ‰æ•ˆ
- å•†å“ä»·æ ¼æ˜¯å¦ä¸ºæ­£æ•°

**è§£å†³**ï¼š
- æŸ¥çœ‹æµè§ˆå™¨æŽ§åˆ¶å°é”™è¯¯
- æŸ¥çœ‹åŽç«¯æ—¥å¿—
- è®¿é—® Stripe Dashboard æŸ¥çœ‹é”™è¯¯è¯¦æƒ…

### Q: è´§å¸æ˜¾ç¤ºä¸º USD è€Œä¸æ˜¯ CNYï¼Ÿ
**æ£€æŸ¥**ï¼š
- åŽç«¯ `views.py` ä¸­ `currency` æ˜¯å¦è®¾ç½®ä¸º `'cny'`
- æ˜¯å¦é‡å¯äº†åŽç«¯æœåŠ¡

**è§£å†³**ï¼š
```python
# ç¡®è®¤ backend/shopping/views.py ä¸­ï¼š
'currency': 'cny',  # å¿…é¡»æ˜¯ 'cny'
```

## ðŸ“ æµ‹è¯•è®°å½•æ¨¡æ¿

å¤åˆ¶æ­¤æ¨¡æ¿è®°å½•æ¯æ¬¡æµ‹è¯•ï¼š

```
æµ‹è¯•æ—¶é—´: 2025-XX-XX XX:XX
æµ‹è¯•åœºæ™¯: [æˆåŠŸæ”¯ä»˜/éªŒè¯æ”¯ä»˜/å¤±è´¥æ”¯ä»˜]
æµ‹è¯•å¡å·: 4242 4242 4242 4242
è®¢å•ç¼–å·: 
æ”¯ä»˜é‡‘é¢: Â¥XXX.XX
æµ‹è¯•ç»“æžœ: [æˆåŠŸ/å¤±è´¥]
å¤‡æ³¨: 

æ£€æŸ¥é¡¹:
- [ ] è®¢å•åˆ›å»º
- [ ] Stripe è·³è½¬
- [ ] æ”¯ä»˜å®Œæˆ
- [ ] çŠ¶æ€æ›´æ–°
- [ ] Webhook æŽ¥æ”¶
```

## ðŸŽ‰ æµ‹è¯•æˆåŠŸæ ‡å‡†

å½“ä»¥ä¸‹æ‰€æœ‰é¡¹éƒ½æˆåŠŸæ—¶ï¼ŒStripe é›†æˆå³ä¸ºå®Œæˆï¼š

1. âœ… èƒ½å¤Ÿåˆ›å»ºè®¢å•
2. âœ… èƒ½å¤Ÿè·³è½¬åˆ° Stripe Checkout
3. âœ… æ˜¾ç¤ºæ­£ç¡®çš„è´§å¸ï¼ˆÂ¥CNYï¼‰
4. âœ… èƒ½å¤Ÿä½¿ç”¨æµ‹è¯•å¡å·æ”¯ä»˜
5. âœ… æ”¯ä»˜æˆåŠŸåŽè·³è½¬åˆ°æˆåŠŸé¡µé¢
6. âœ… è®¢å•çŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸º"å·²æ”¯ä»˜"
7. âœ… Webhook æ­£ç¡®æŽ¥æ”¶å¹¶å¤„ç†äº‹ä»¶
8. âœ… å¾…ä»˜æ¬¾è®¢å•å¯ä»¥é‡æ–°æ”¯ä»˜
9. âœ… æ”¯ä»˜å¤±è´¥èƒ½å¤Ÿæ­£ç¡®å¤„ç†å’Œæ˜¾ç¤ºé”™è¯¯

---

**å¼€å§‹æµ‹è¯•å§ï¼** ðŸ’³âœ¨

å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹ï¼š
- æµè§ˆå™¨æŽ§åˆ¶å°ï¼ˆF12ï¼‰
- Django ç»ˆç«¯æ—¥å¿—
- Stripe CLI ç»ˆç«¯
- Stripe Dashboard: https://dashboard.stripe.com/test/payments
